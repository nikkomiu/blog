#!/usr/bin/env node

const common = require('./common');
const colors = require('colors');

async function buildHugo() {
  const extraArgs = ['--'];
  if (process.env.WITH_DRAFTS === 'true') {
    console.log(`Building with drafts: ${process.env.WITH_DRAFTS}\n`.yellow)
    extraArgs.push('--buildDrafts');
  }

  const [procName] = common.runProcess('npm', ['run', 'build:hugo', ...extraArgs]);

  await Promise.all([
    common.waitForProcess(procName),
    common.waitForFile('public/index.html'),
  ]);
}

async function buildSearch() {
  const [procName] = common.runProcess('npm', ['run', 'build:search']);

  await Promise.all([
    common.waitForProcess(procName),
    common.waitForFile('public/_pagefind/pagefind.js'),
  ]);
}

async function main() {
  await buildHugo();
  await common.loadManualCSS();
  await buildSearch();
}

main().catch((err) => {
  console.error(colors.red(err));
  process.exit(1);
});
